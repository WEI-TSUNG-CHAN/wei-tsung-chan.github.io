<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>麻將計算資料</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: 'Orbitron', sans-serif;
            color: rgba(220, 230, 240, 0.85);
        }

        table {
            width: 300px;
            margin: 40px auto;
            border-collapse: collapse;
            background-color: rgba(20, 24, 30, 0.88);
            border: 1px solid rgba(100, 100, 100, 0.2);
            border-radius: 8px;
        }

        th,
        td {
            padding: 0.4rem 0.6rem;
            text-align: center;
            border: 1px solid rgba(80, 80, 80, 0.3);
            font-size: 2rem;
            color: rgba(240, 250, 255, 0.92);
        }

        th {
            background-color: rgba(35, 40, 50, 0.95);
            color: rgba(79, 195, 247, 0.95);
            font-weight: 700;
        }

        td:first-child {
            color: gold;
            font-weight: 700;
        }

        h1 {
            display: none;
        }

        tbody {
            display: table-row-group;
        }

        tfoot td {
            font-weight: bold;
            background-color: rgba(30, 36, 45, 0.9);
            color: #39ff14 !important;
            /* 螢光綠，非常醒目 */
        }

        /* 新增 winner-caption 樣式 */
        caption.winner-caption {
            caption-side: top;
            font-size: 2.5rem;
            font-weight: 800;
            color: #FF6F3C;
            /* 活潑橘紅 */
            letter-spacing: 0.08em;
            /* 字間微拉 */
            text-shadow: 1px 1px 3px rgba(255, 111, 60, 0.6);
            /* 暖色陰影 */
            padding-bottom: 0.6rem;
            user-select: none;
            font-family: 'Orbitron', sans-serif;
            /* 保持整體字體 */
        }
    </style>

</head>

<body>
    <table>
        <caption id="winner-caption" class="winner-caption"></caption>
        </caption>
        <thead>
            <tr>
                <th>類型</th>
                <th>台數</th>
            </tr>
        </thead>
        <tbody id="data-body">
            <!-- 資料將由 JS 動態插入 -->
        </tbody>
        <tfoot>
            <tr>
                <td colspan="2" id="total-row">合計：0 台</td>
            </tr>
        </tfoot>
    </table>

    <script>
        let lastDataStr = null; // 紀錄上次計算資料字串
        let lastWinner = null;  // 紀錄上次冠軍名稱
        const table = document.querySelector('table');
        const winnerCaption = document.getElementById('winner-caption');

        // 載入冠軍資訊
        function loadWinner() {
            return fetch('/directions/all')
                .then(res => res.json())
                .then(dirData => {
                    const winnerObj = dirData.find(d => d.key_name === 'winner');
                    const winnerName = winnerObj && winnerObj.value_name ? winnerObj.value_name : null;
                    return winnerName;
                });
        }

        // 載入計算資料
        function loadCalculateData() {
            return fetch('/calculate/active', { method: 'POST' })
                .then(res => res.json())
                .then(data => data);
        }

        // 主要更新函式：載入冠軍+計算資料，判斷是否更新和顯示隱藏
        function refreshData() {
            Promise.all([loadWinner(), loadCalculateData()])
                .then(([winnerName, calcData]) => {
                    const dataStr = JSON.stringify(calcData);
                    // 判斷資料是否有變化（冠軍或計算資料）
                    if (dataStr === lastDataStr && winnerName === lastWinner) {
                        // 沒變就隱藏表格
                        table.style.display = 'none';
                        return;
                    }
                    // 有變化則更新並顯示表格
                    lastDataStr = dataStr;
                    lastWinner = winnerName;
                    table.style.display = 'table';

                    // 更新冠軍顯示
                    winnerCaption.textContent = winnerName ? `🎉WIN ${winnerName}` : '';

                    // 更新計算資料表格
                    const tbody = document.getElementById('data-body');
                    const totalRow = document.getElementById('total-row');
                    tbody.innerHTML = '';

                    let totalTie = 0;
                    calcData.sort((a, b) => a.tie - b.tie);

                    calcData.forEach(item => {
                        totalTie += parseInt(item.tie, 10);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.type}</td>
                            <td>${item.tie}</td>
                        `;
                        tbody.appendChild(row);
                    });

                    totalRow.textContent = `合計：${totalTie} 台`;
                })
                .catch(err => {
                    console.error('資料載入錯誤:', err);
                    // 出錯也可選擇隱藏表格或顯示錯誤訊息
                    winnerCaption.textContent = '載入冠軍資訊失敗';
                    table.style.display = 'none';
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            refreshData();
            setInterval(refreshData, 8000);
        });
    </script>
</body>



</html>