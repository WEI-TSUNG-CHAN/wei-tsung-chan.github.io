<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>éº»å°‡è¨ˆç®—è³‡æ–™</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: 'Orbitron', sans-serif;
            color: rgba(220, 230, 240, 0.85);
        }

        table {
            width: 300px;
            margin: 40px auto;
            border-collapse: collapse;
            background-color: rgba(20, 24, 30, 0.88);
            border: 1px solid rgba(100, 100, 100, 0.2);
            border-radius: 8px;
        }

        th,
        td {
            padding: 0.4rem 0.6rem;
            text-align: center;
            border: 1px solid rgba(80, 80, 80, 0.3);
            font-size: 2rem;
            color: rgba(240, 250, 255, 0.92);
        }

        th {
            background-color: rgba(35, 40, 50, 0.95);
            color: rgba(79, 195, 247, 0.95);
            font-weight: 700;
        }

        td:first-child {
            color: gold;
            font-weight: 700;
        }

        h1 {
            display: none;
        }

        tbody {
            display: table-row-group;
        }

        tfoot td {
            font-weight: bold;
            background-color: rgba(30, 36, 45, 0.9);
            color: #39ff14 !important;
            /* è¢å…‰ç¶ ï¼Œéå¸¸é†’ç›® */
        }

        /* æ–°å¢ winner-caption æ¨£å¼ */
        caption.winner-caption {
            caption-side: top;
            font-size: 2.5rem;
            font-weight: 800;
            color: #FF6F3C;
            /* æ´»æ½‘æ©˜ç´… */
            letter-spacing: 0.08em;
            /* å­—é–“å¾®æ‹‰ */
            text-shadow: 1px 1px 3px rgba(255, 111, 60, 0.6);
            /* æš–è‰²é™°å½± */
            padding-bottom: 0.6rem;
            user-select: none;
            font-family: 'Orbitron', sans-serif;
            /* ä¿æŒæ•´é«”å­—é«” */
        }
    </style>

</head>

<body>
    <table>
        <caption id="winner-caption" class="winner-caption"></caption>
        </caption>
        <thead>
            <tr>
                <th>é¡å‹</th>
                <th>å°æ•¸</th>
            </tr>
        </thead>
        <tbody id="data-body">
            <!-- è³‡æ–™å°‡ç”± JS å‹•æ…‹æ’å…¥ -->
        </tbody>
        <tfoot>
            <tr>
                <td colspan="2" id="total-row">åˆè¨ˆï¼š0 å°</td>
            </tr>
        </tfoot>
    </table>

    <script>
        let lastDataStr = null; // ç´€éŒ„ä¸Šæ¬¡è¨ˆç®—è³‡æ–™å­—ä¸²
        let lastWinner = null;  // ç´€éŒ„ä¸Šæ¬¡å† è»åç¨±
        const table = document.querySelector('table');
        const winnerCaption = document.getElementById('winner-caption');

        // è¼‰å…¥å† è»è³‡è¨Š
        function loadWinner() {
            return fetch('/directions/all')
                .then(res => res.json())
                .then(dirData => {
                    const winnerObj = dirData.find(d => d.key_name === 'winner');
                    const winnerName = winnerObj && winnerObj.value_name ? winnerObj.value_name : null;
                    return winnerName;
                });
        }

        // è¼‰å…¥è¨ˆç®—è³‡æ–™
        function loadCalculateData() {
            return fetch('/calculate/active', { method: 'POST' })
                .then(res => res.json())
                .then(data => data);
        }

        // ä¸»è¦æ›´æ–°å‡½å¼ï¼šè¼‰å…¥å† è»+è¨ˆç®—è³‡æ–™ï¼Œåˆ¤æ–·æ˜¯å¦æ›´æ–°å’Œé¡¯ç¤ºéš±è—
        function refreshData() {
            Promise.all([loadWinner(), loadCalculateData()])
                .then(([winnerName, calcData]) => {
                    const dataStr = JSON.stringify(calcData);
                    // åˆ¤æ–·è³‡æ–™æ˜¯å¦æœ‰è®ŠåŒ–ï¼ˆå† è»æˆ–è¨ˆç®—è³‡æ–™ï¼‰
                    if (dataStr === lastDataStr && winnerName === lastWinner) {
                        // æ²’è®Šå°±éš±è—è¡¨æ ¼
                        table.style.display = 'none';
                        return;
                    }
                    // æœ‰è®ŠåŒ–å‰‡æ›´æ–°ä¸¦é¡¯ç¤ºè¡¨æ ¼
                    lastDataStr = dataStr;
                    lastWinner = winnerName;
                    table.style.display = 'table';

                    // æ›´æ–°å† è»é¡¯ç¤º
                    winnerCaption.textContent = winnerName ? `ğŸ‰WIN ${winnerName}` : '';

                    // æ›´æ–°è¨ˆç®—è³‡æ–™è¡¨æ ¼
                    const tbody = document.getElementById('data-body');
                    const totalRow = document.getElementById('total-row');
                    tbody.innerHTML = '';

                    let totalTie = 0;
                    calcData.sort((a, b) => a.tie - b.tie);

                    calcData.forEach(item => {
                        totalTie += parseInt(item.tie, 10);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.type}</td>
                            <td>${item.tie}</td>
                        `;
                        tbody.appendChild(row);
                    });

                    totalRow.textContent = `åˆè¨ˆï¼š${totalTie} å°`;
                })
                .catch(err => {
                    console.error('è³‡æ–™è¼‰å…¥éŒ¯èª¤:', err);
                    // å‡ºéŒ¯ä¹Ÿå¯é¸æ“‡éš±è—è¡¨æ ¼æˆ–é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    winnerCaption.textContent = 'è¼‰å…¥å† è»è³‡è¨Šå¤±æ•—';
                    table.style.display = 'none';
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            refreshData();
            setInterval(refreshData, 8000);
        });
    </script>
</body>



</html>