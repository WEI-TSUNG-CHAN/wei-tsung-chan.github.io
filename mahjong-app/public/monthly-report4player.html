<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>本月四位玩家分數統計</title>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
    }

    table {
      width: 220px;
      margin: 0 auto;
      border-collapse: separate;
      border-spacing: 0 14px;
      /* 卡片間距 */
    }

    td {
      background: rgba(20, 24, 30, 0.45);
      backdrop-filter: blur(6px);
      border-radius: 10px;
      padding: 12px 16px;
    }

    .player-name {
      font-size: 1.4rem;
      font-weight: 600;
      color: #FFFFFF;
      letter-spacing: 1px;
    }

    .score-row {
      margin-top: 4px;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .label {
      font-size: 0.9rem;
      color: #BFBFBF;
    }

    .score {
      font-size: 1.6rem;
      font-weight: 700;
      transition: 0.3s ease;
    }

    .positive {
      color: #FFD54F;
    }

    .negative {
      color: #FF6B6B;
    }

    .flash {
      animation: flashAnim 0.6s ease;
    }

    @keyframes flashAnim {
      0% {
        transform: scale(1.15);
      }

      100% {
        transform: scale(1);
      }
    }
  </style>
</head>

<body>
  <table>
    <tbody id="report-body">
      <tr>
        <td>載入中...</td>
      </tr>
    </tbody>
  </table>

  <script>
    let previousStatsMap = {};

    async function fetchDirections() {
      const res = await fetch('/directions/all');
      const data = await res.json();
      const map = {};
      data.forEach(item => map[item.key_name] = item.value_name);
      return map;
    }

    async function fetchMonthlyStats(date) {
      const res = await fetch(`/stats/month?date=${encodeURIComponent(date)}`);
      return res.json();
    }

    async function renderMonthlyReport() {

      const dir = await fetchDirections();
      const date = dir['assign_date'];
      const players = [
        dir['player1'],
        dir['player2'],
        dir['player3'],
        dir['player4']
      ];

      const stats = await fetchMonthlyStats(date);

      const statsMap = {};
      stats.forEach(s => {
        statsMap[s.player_name] = s.total_score;
      });

      const tbody = document.getElementById('report-body');

      tbody.innerHTML = players.map(name => {

        const score = statsMap[name] ?? 0;
        const prevScore = previousStatsMap[name];

        const changed = prevScore !== undefined && prevScore !== score;
        const signClass = score >= 0 ? 'positive' : 'negative';
        const flashClass = changed ? 'flash' : '';

        // 判斷是不是老王
        const isLaoWang = name === '老王';
        const rowStyle = isLaoWang
          ? 'font-weight:900; color: gold; text-shadow: 0 0 10px gold, 0 0 20px orange;'
          : '';

        return `
          <tr style="${rowStyle}">
            <td>
              <div class="player-name">${name}</div>
              <div class="score-row">
                <span class="label">月｜</span>
                <span class="score ${signClass} ${flashClass}">
                  ${score}
                </span>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      previousStatsMap = { ...statsMap };
    }

    renderMonthlyReport();
    setInterval(renderMonthlyReport, 5000);
  </script>

</body>

</html>