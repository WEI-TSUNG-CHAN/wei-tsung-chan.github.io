<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <title>æ—¥æˆ°å ±è¡¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet" />
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: 'Orbitron', sans-serif;
            color: rgba(220, 230, 240, 0.85);
        }

        /* ğŸ”¹ æ–°å¢ï¼šæœ¬å°‡æ¨™é¡Œæ¢ */
        .round-label {
            width: 400px;
            margin: 0 auto 6px auto;
            padding: 6px 12px;
            font-size: 1.4rem;
            background: rgba(15, 18, 25, 0.9);
            color: rgba(120, 200, 255, 0.95);
            letter-spacing: 2px;
            border-radius: 6px;
        }

        table {
            width: 400px;
            margin: 0 auto;
            border-collapse: collapse;
            background-color: rgba(20, 24, 30, 0.88);
            border: 1px solid rgba(100, 100, 100, 0.2);
            border-radius: 8px;
        }

        th,
        td {
            margin: 0 auto 6px auto;
            text-align: center;
            border: 1px solid rgba(80, 80, 80, 0.3);
            font-size: 1.2rem;
            color: rgba(240, 250, 255, 0.92);
        }

        th {
            background-color: rgba(35, 40, 50, 0.95);
            color: rgba(79, 195, 247, 0.95);
            font-weight: 700;
        }

        td:first-child {
            color: gold;
            font-weight: 700;
        }

        h1 {
            display: none;
        }

        tbody {
            display: table-row-group;
        }
    </style>
</head>

<body>

    <!-- ğŸ”¹ æ–°å¢æ¨™ç¤ºï¼šæ˜ç¢ºå‘Šè¨´è§€çœ¾é€™æ˜¯æœ¬å°‡ -->
    <div class="round-label" id="round-label">
        æœ¬å°‡å³æ™‚æˆ°å ±
    </div>

    <table>
        <thead>
            <tr>
                <th>ç©å®¶</th>
                <th>æœ¬å°‡åˆ†æ•¸</th> <!-- ğŸ”¹ æ”¹é€™è£¡ -->
                <th>è‡ªæ‘¸</th>
                <th>èƒ¡ç‰Œ</th>
                <th>æ§</th>
            </tr>
        </thead>
        <tbody id="report-body">
            <tr>
                <td colspan="5">è¼‰å…¥ä¸­...</td>
            </tr>
        </tbody>
    </table>

    <script>
        // ğŸ”¹ ä¿ç•™åŸæœ¬ fetchDirections èˆ‡ fetchStatsï¼Œä¸æ”¹å‹•
        let previousData = [];

        async function fetchDirections() {
            const res = await fetch('/directions/all');
            const data = await res.json();
            const map = {};
            data.forEach(item => map[item.key_name] = item.value_name);
            return map;
        }

        async function fetchStats(date, round_number) {
            const res = await fetch(`/stats?date=${encodeURIComponent(date)}&round_number=${round_number}`);
            return res.json();
        }

        function isDifferent(oldItem, newItem) {
            return oldItem.total_score !== newItem.total_score ||
                oldItem.total_zi !== newItem.total_zi ||
                oldItem.total_hu !== newItem.total_hu ||
                oldItem.total_qiang !== newItem.total_qiang;
        }

        async function renderReport() {
            const dir = await fetchDirections();
            const date = dir['assign_date'];
            const round = dir['round_number'];
            const players = [dir['player1'], dir['player2'], dir['player3'], dir['player4']];
            const stats = await fetchStats(date, round);

            let displayStats;

            if (stats.length > 0) {
                displayStats = stats.map(s => ({
                    player_name: s.player_name,
                    total_score: s.total_score,
                    total_zi: s.total_zi,
                    total_hu: s.total_hu,
                    total_qiang: s.total_qiang
                }));
            } else {
                displayStats = players.map(name => ({
                    player_name: name,
                    total_score: 0,
                    total_zi: 0,
                    total_hu: 0,
                    total_qiang: 0
                }));
            }

            // ğŸ”¹ è¨ˆç®—å±€æ•¸ï¼ˆtotal_hu åŠ ç¸½ï¼Œç¢ºä¿æ•¸å­—å‹åˆ¥ï¼‰
            const totalHu = displayStats.reduce((sum, p) => sum + Number(p.total_hu), 0);

            // ğŸ”¹ æ›´æ–°è¡¨é ­æ–‡å­—ï¼ˆå³æ™‚æˆ°å ±å¾ŒåŠ ä¸Šå±€æ•¸ï¼‰
            //document.getElementById('round-label').innerHTML = `ç¬¬ <span style="color:red; font-weight:bold;">${round}</span> å°‡ï½œå³æ™‚æˆ°å ±ï½œç´¯ç©å±€æ•¸ <span style="color:red; font-weight:bold;">${totalHu}</span>`;
            document.getElementById('round-label').innerHTML =
                `<span style="color:green; font-weight:bold;">å³æ™‚æˆ°å ±</span> ï½œæœ¬å°‡ç´¯ç©å±€æ•¸ <span style="color:red; font-weight:bold;">${totalHu}</span>`;

            // ğŸ”¹ æ›´æ–°è¡¨æ ¼å…§å®¹ï¼ˆä¿ç•™åŸæœ¬é‚è¼¯ï¼‰
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = displayStats.map((p, i) => {
                const prev = previousData[i];
                const changed = prev && isDifferent(prev, p);

                return `
            <tr>
                <td>${p.player_name}</td>
                <td style="${changed ? 'color:#FFD54F;' : ''}">${p.total_score}</td>
                <td style="${changed ? 'color:#FFD54F;' : ''}">${p.total_zi}</td>
                <td style="${changed ? 'color:#FFD54F;' : ''}">${p.total_hu}</td>
                <td style="${changed ? 'color:#FFD54F;' : ''}">${p.total_qiang}</td>
            </tr>
        `;
            }).join('');

            previousData = JSON.parse(JSON.stringify(displayStats));
        }

        // ğŸ”¹ åˆå§‹æ¸²æŸ“
        renderReport();
        setInterval(renderReport, 5000);
    </script>

</body>

</html>